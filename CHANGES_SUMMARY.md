# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ UV-K5

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. –û—à–∏–±–∫–∞ handshake
**–ü—Ä–æ–±–ª–µ–º–∞**: `The operation couldn't be completed. (QuanshengK5Tool.K5ProtocolError error 0.)`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–ª—è UV-K5
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã magic bytes `AB CD EF AB CD EF AB CD` –¥–ª—è –∫–æ–º–∞–Ω–¥ UV-K5
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã 5 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ handshake
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏ –ø–µ—Ä–µ–¥ handshake
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π

### 2. –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤–æ–ª—å—Ç–∞–∂–∞ –±–∞—Ç–∞—Ä–µ–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: `–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤–æ–ª—å—Ç–∞–∂–∞ –±–∞—Ç–∞—Ä–µ–∏: The operation couldn't be completed.`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —á—Ç–µ–Ω–∏—è ADC –±–∞—Ç–∞—Ä–µ–∏ UV-K5
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã 5 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —á—Ç–µ–Ω–∏—è –≤–æ–ª—å—Ç–∞–∂–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–ª—è UV-K5
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º

## –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –§—É–Ω–∫—Ü–∏—è `performHandshake()`
```swift
// –°—Ç–∞—Ä—ã–π –∫–æ–¥ - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
let identifyCommand = Data([0x02])

// –ù–æ–≤—ã–π –∫–æ–¥ - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã UV-K5
let helloCommand = Data([
    0xAB, 0xCD, 0xEF, 0xAB, 0xCD, 0xEF, 0xAB, 0xCD,  // Magic bytes
    0x14                                                // –ö–æ–º–∞–Ω–¥–∞ Hello
])
```

### 2. –§—É–Ω–∫—Ü–∏—è `readBatteryVoltage()`
```swift
// –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è UV-K5
("UV-K5 Battery ADC", Data([
    0xAB, 0xCD, 0xEF, 0xAB, 0xCD, 0xEF, 0xAB, 0xCD,  // Magic bytes
    0x1B,                                              // –ö–æ–º–∞–Ω–¥–∞ —á—Ç–µ–Ω–∏—è EEPROM
    0xC8, 0x1E,                                        // –ê–¥—Ä–µ—Å ADC –±–∞—Ç–∞—Ä–µ–∏
    0x02                                               // 2 –±–∞–π—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
]))
```

### 3. –§—É–Ω–∫—Ü–∏—è `testCommunication()`
```swift
// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–∏
func testCommunication(interface: IOUSBInterfaceInterface300?) async throws -> Bool {
    // –¢–µ—Å—Ç–∏—Ä—É–µ—Ç 6 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
}
```

### 4. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```swift
// –°—Ç–∞—Ä—ã–π –∫–æ–¥
logManager.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã", level: .debug)

// –ù–æ–≤—ã–π –∫–æ–¥ —Å —ç–º–æ–¥–∑–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
logManager.log("üì° –ö–æ–º–∞–Ω–¥–∞ 1 (UV-K5 Battery ADC): AB CD EF AB CD EF AB CD 1B C8 1E 02", level: .debug)
logManager.log("üì• –û—Ç–≤–µ—Ç 1: 3C 14 1E 28", level: .debug)
logManager.log("‚úÖ –í–æ–ª—å—Ç–∞–∂ –ø—Ä–æ—á–∏—Ç–∞–Ω: 3.756V (raw: 0x1E3C)", level: .success)
```

### 5. –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```swift
// –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
catch let error as K5ProtocolError {
    switch error {
    case .deviceNotConnected:
        logManager.log("‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ", level: .error)
    case .communicationError:
        logManager.log("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º", level: .error)
    // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
    }
}
```

## –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã

1. **`QuanshengK5Tool/K5Protocol.swift`**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `performHandshake()`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `readBatteryVoltage()`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `readBatteryCalibration()`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `testCommunication()`
   - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

2. **`QuanshengK5Tool/USBCommunication.swift`**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏ –ø–µ—Ä–µ–¥ handshake
   - –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `readBatteryVoltage()`
   - –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `readDeviceInfo()`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

## –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. **`UV-K5_Protocol_Documentation.md`** - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ UV-K5
2. **`test_protocol.sh`** - –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. **`CHANGES_SUMMARY.md`** - –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
   ```bash
   ./test_protocol.sh
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ UV-K5

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —ç–º–æ–¥–∑–∏:
   - üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏
   - ü§ù Handshake
   - üîã –ß—Ç–µ–Ω–∏–µ –≤–æ–ª—å—Ç–∞–∂–∞
   - ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   - ‚ùå –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ Handshake –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å UV-K5
- ‚úÖ –ß—Ç–µ–Ω–∏–µ –≤–æ–ª—å—Ç–∞–∂–∞ –±–∞—Ç–∞—Ä–µ–∏ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –õ–æ–≥–∏ –±—É–¥—É—Ç –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏
- ‚úÖ –û—à–∏–±–∫–∏ –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å UV-K5

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ä—Ç–∞**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 38400 –±–æ–¥
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–±–µ–ª—å**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π USB-–∫–∞–±–µ–ª—å
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä–∞–π–≤–µ—Ä—ã**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã –¥–ª—è USB-—Å–µ—Ä–∏–π–Ω–æ–≥–æ –∞–¥–∞–ø—Ç–µ—Ä–∞
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ UV-K5 –≤–∫–ª—é—á–µ–Ω –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ (–Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—Ä–µ–¥–∞—á–∏)