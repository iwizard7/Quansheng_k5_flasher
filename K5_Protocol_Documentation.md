# Документация протокола Quansheng K5

## Обзор

Quansheng K5 использует USB интерфейс для программирования и управления. Устройство работает в режиме CDC (Communication Device Class) и использует собственный протокол команд.

## USB параметры

- **Vendor ID (VID)**: `0x0483` (STMicroelectronics)
- **Product ID (PID)**: `0x5740` (Quansheng K5)
- **Интерфейс**: CDC ACM (Abstract Control Model)
- **Endpoints**: 
  - OUT: 0x01 (команды к устройству)
  - IN: 0x81 (ответы от устройства)

## Структура команд

Все команды имеют следующую структуру:

```
[CMD] [LEN] [ADDR_L] [ADDR_H] [DATA...] [CHECKSUM]
```

Где:
- `CMD` - код команды (1 байт)
- `LEN` - длина данных (1 байт)
- `ADDR_L/ADDR_H` - адрес в little-endian формате (2 байта)
- `DATA` - данные переменной длины
- `CHECKSUM` - контрольная сумма XOR всех предыдущих байт

## Основные команды

### Команды связи

| Команда | Код | Описание |
|---------|-----|----------|
| HANDSHAKE | 0x14 | Инициализация связи |
| ACKNOWLEDGE | 0x06 | Подтверждение |

### Команды памяти

| Команда | Код | Описание |
|---------|-----|----------|
| READ_MEMORY | 0x1B | Чтение блока памяти |
| WRITE_MEMORY | 0x1D | Запись блока памяти |
| READ_EEPROM | 0x1A | Чтение EEPROM |
| WRITE_EEPROM | 0x1C | Запись EEPROM |

### Команды загрузчика

| Команда | Код | Описание |
|---------|-----|----------|
| ENTER_BOOTLOADER | 0x18 | Вход в режим загрузчика |
| EXIT_BOOTLOADER | 0x16 | Выход из режима загрузчика |
| ERASE_FLASH | 0x15 | Стирание flash памяти |
| WRITE_FLASH | 0x19 | Запись flash памяти |

### Информационные команды

| Команда | Код | Описание |
|---------|-----|----------|
| READ_VERSION | 0x17 | Чтение версии прошивки |
| READ_DEVICE_ID | 0x05 | Чтение ID устройства |

### Специфичные команды K5

| Команда | Код | Описание |
|---------|-----|----------|
| READ_CALIBRATION | 0x33 | Чтение калибровочных данных |
| WRITE_CALIBRATION | 0x34 | Запись калибровочных данных |
| READ_SETTINGS | 0x35 | Чтение настроек |
| WRITE_SETTINGS | 0x36 | Запись настроек |

## Карта памяти

### Flash память (64KB)
- **Адрес**: 0x08000000 - 0x0800FFFF
- **Размер**: 64KB
- **Содержимое**: Основная прошивка

### EEPROM (8KB)
- **Адрес**: 0x0000 - 0x1FFF
- **Размер**: 8KB
- **Содержимое**: Настройки, каналы, калибровка

### Основные области EEPROM

| Область | Адрес | Размер | Описание |
|---------|-------|--------|----------|
| Информация об устройстве | 0x0000 | 64 байта | Серийный номер, дата производства |
| Основные настройки | 0x0E70 | 32 байта | Частота по умолчанию, мощность, и т.д. |
| Настройки меню | 0x0F50 | 32 байта | Настройки интерфейса |
| Каналы памяти | 0x0F30 | 3200 байт | 200 каналов по 16 байт |
| Список сканирования | 0x1D00 | 256 байт | Настройки сканирования |
| Настройки DTMF | 0x1E00 | 128 байт | DTMF коды и настройки |
| Настройки FM радио | 0x1E80 | 64 байта | Предустановки FM |
| Калибровка батареи | 0x1EC0 | 16 байт | Калибровочные данные батареи |
| Калибровка TX | 0x1F40 | 32 байта | Калибровка передатчика |
| Калибровка RX | 0x1F60 | 32 байта | Калибровка приемника |
| Калибровка RSSI | 0x1F80 | 32 байта | Калибровка индикатора сигнала |

## Процедура Handshake

Для установления связи с K5 необходимо выполнить трехэтапный handshake:

### Этап 1: Инициализация
```
Отправить: 14 05 04 00 6A 39 57 64
Ожидать:   18 XX XX XX XX XX XX XX
```

### Этап 2: Подтверждение
```
Отправить: 14 05 20 15 75 25
Ожидать:   18 XX XX XX
```

### Этап 3: Готовность
```
Отправить: 06 02 00 00
Ожидать:   06 XX XX XX
```

## Структура канала (16 байт)

| Байт | Описание |
|------|----------|
| 0-3 | Частота в Hz (little-endian, умножить на 10) |
| 4 | Настройки: биты 0-1 мощность, бит 4 полоса, бит 5 скремблер |
| 5-6 | RX тон (CTCSS*10 или DCS код) |
| 7-8 | TX тон (CTCSS*10 или DCS код) |
| 9-15 | Название канала (ASCII, дополнено нулями) |

### Кодирование мощности передачи
- 0 = Низкая (1W)
- 1 = Средняя (2W)  
- 2 = Высокая (5W)

### Кодирование полосы пропускания
- 0 = Узкая (12.5 kHz)
- 1 = Широкая (25 kHz)

### Кодирование тонов
- 0x0000 = Нет тона
- 0x0001-0x0999 = CTCSS (значение/10 = частота в Hz)
- 0x1000+ = DCS код

## Структура настроек (32 байта)

| Байт | Описание |
|------|----------|
| 0-3 | Частота по умолчанию в Hz (little-endian) |
| 4 | Мощность передачи по умолчанию |
| 5 | Автосканирование (0/1) |
| 6 | Яркость подсветки (0-100) |
| 7 | Автоотключение подсветки (0/1) |
| 8-31 | Резерв |

## Калибровочные данные

### Калибровка батареи (16 байт)
Содержит коэффициенты для преобразования ADC значений в вольты:
- Байты 0-1: Коэффициент A (little-endian)
- Байты 2-3: Коэффициент B (little-endian)
- Байты 4-15: Резерв

### Калибровка RSSI (32 байта)
Содержит таблицу преобразования RSSI значений для разных частот.

## Безопасность

### Важные предупреждения
1. **Никогда не отключайте устройство во время записи flash памяти**
2. **Всегда проверяйте контрольные суммы перед записью**
3. **Создавайте резервные копии перед изменением калибровки**
4. **Используйте только проверенные файлы прошивки**

### Восстановление после сбоя
Если устройство не отвечает после неудачной прошивки:
1. Отключите питание на 10 секунд
2. Зажмите кнопку PTT при включении для входа в режим восстановления
3. Используйте специальную утилиту восстановления

## Примеры команд

### Чтение версии прошивки
```
Отправить: 17 00 00 20 37
Ожидать:   06 10 [16 байт версии] [checksum]
```

### Чтение канала 1
```
Отправить: 1A 10 30 0F 55
Ожидать:   06 10 [16 байт канала] [checksum]
```

### Запись настроек
```
Отправить: 1C 20 70 0E [32 байта настроек] [checksum]
Ожидать:   06 00 00 00 06
```

## Отладка

### Логирование USB трафика
Для отладки используйте:
```bash
# macOS
log stream --predicate 'subsystem == "com.apple.iokit.usb"'

# Или специализированные утилиты
sudo dtruss -p [PID приложения] 2>&1 | grep usb
```

### Частые ошибки
1. **Timeout** - устройство не отвечает, проверьте подключение
2. **Invalid checksum** - ошибка в контрольной сумме
3. **Device busy** - устройство занято другим процессом
4. **Permission denied** - недостаточно прав доступа к USB

## Совместимость

Этот протокол совместим с:
- Quansheng K5 (все ревизии)
- Возможно совместим с другими моделями Quansheng на том же чипсете

## Ссылки

- [Официальный сайт Quansheng](http://www.qsj.com.cn/)
- [Сообщество радиолюбителей K5](https://github.com/ludwich66/Quansheng_K5)
- [Документация по реверс-инжинирингу](https://github.com/sq5bpf/k5prog)